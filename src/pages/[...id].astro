---
import Layout from "@layouts/Layout.astro";
import Container from "@components/Container.astro";
import BackToPrevious from "@components/BackToPrevious.astro";
import FormattedDate from "@components/FormattedDate.astro";
import TableOfContents from "@components/TableOfContents.astro";
import Backlinks from "@components/Backlinks.astro";
import Giscus from "@components/Giscus.astro";
import { getBacklinksFor, getDocumentDate, getDocuments } from "@lib/documents";
import { renderMarkdown } from "@lib/markdown";
import { readingTime, titleCase } from "@lib/utils";
import type { Document } from "@types/documents";

export async function getStaticPaths() {
  const documents = getDocuments();
  return documents.map((doc) => ({
    params: { id: doc.canonical.replace(/^\//, "") },
    props: doc,
  }));
}

const doc = Astro.props as Document;
const { code, metadata } = await renderMarkdown(doc.body_md || "");
const date = getDocumentDate(doc);
const backlinks = getBacklinksFor(doc.canonical);
const collectionPath = `/${doc.collection}`;
const collectionLabel = doc.collection
  .split("/")
  .map((segment) => titleCase(segment))
  .join(" / ");
const estimatedReading = doc.body_md ? readingTime(code) : null;
---

<Layout title={doc.title} description={doc.summary ?? doc.title}>
  <Container>
    <div class="animate">
      <BackToPrevious href={collectionPath}>
        {collectionLabel}
      </BackToPrevious>
    </div>
    <div class="my-10 space-y-2">
      <div class="animate flex flex-wrap items-center gap-2 text-sm text-black/60 dark:text-white/60">
        {date && (
          <span>
            <FormattedDate date={date} />
          </span>
        )}
        {date && estimatedReading && <span>â€¢</span>}
        {estimatedReading && <span>{estimatedReading}</span>}
      </div>
      <h1 class="animate text-3xl font-semibold text-black dark:text-white">
        {doc.title}
      </h1>
      {doc.summary && (
        <p class="max-w-2xl text-black/70 dark:text-white/70">
          {doc.summary}
        </p>
      )}
    </div>
    {metadata.headings.length > 0 && (
      <TableOfContents headings={metadata.headings} />
    )}
    <article class="animate">
      <div set:html={code} />
    </article>
    <Backlinks backlinks={backlinks} />
    <div class="mt-16">
      <Giscus />
    </div>
  </Container>
</Layout>
